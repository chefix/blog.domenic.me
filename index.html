
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Hidden Variables</title>
  <meta name="author" content="Domenic Denicola">

  
  <meta name="description" content="Domenic's blog about coding and stuff">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://blog.domenic.me/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Hidden Variables" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<meta property="twitter:account_id" content="30968081" />



  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37626687-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Hidden Variables</a></h1>
  
    <h2>Domenic's blog about coding and stuff</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.domenic.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/the-revealing-constructor-pattern/">The Revealing Constructor Pattern</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-13T19:00:00-05:00" pubdate data-updated="true">Feb 13<sup>th</sup>, 2014</time>
        
         | <a href="/the-revealing-constructor-pattern/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I want to document an interesting pattern we&rsquo;ve seen emerge in some recent web platform specs, including <a href="https://people.mozilla.org/%7Ejorendorff/es6-draft.html#sec-promise-objects">promises</a> and <a href="https://github.com/whatwg/streams">streams</a>. I&rsquo;m calling it the <strong>revealing constructor pattern</strong>.</p>

<h2 id="the-promises-example">The Promises Example</h2>

<p>Let&rsquo;s take the case of promises first, since that may be familiar. You can construct a new promise like so:</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Use `resolve` to resolve `p`.</span>
    <span class="c1">// Use `reject` to reject `p`.</span>
<span class="p">});</span>
</code></pre></figure>

<p>We see here that the <code>Promise</code> constructor takes a single function as its sole parameter (called the &ldquo;executor function&rdquo;). It then <em>immediately</em> calls that function with two arguments, <code>resolve</code> and <code>reject</code>. These arguments have the capability to manipulate the internal state of the newly-constructed <code>Promise</code> instance <code>p</code>.</p>

<p>I call this the revealing constructor pattern because the <code>Promise</code> constructor is <em>revealing</em> its internal capabilities, but only to the code that constructs the promise in question. The ability to resolve or reject the promise is only revealed to the constructing code, and is crucially <em>not</em> revealed to anyone <em>using</em> the promise. So if we hand off <code>p</code> to another consumer, say</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="nx">doThingsWith</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
</code></pre></figure>

<p>then we can be sure that this consumer cannot mess with any of the internals that were revealed to us by the constructor. This is as opposed to, for example, putting <code>resolve</code> and <code>reject</code> methods on <code>p</code>, which anyone could call. (And no, adding underscores to the beginning of your method names won&rsquo;t save you.)</p>

<h2 id="historical-origins">Historical Origins</h2>

<p>The first place anyone can remember seeing this pattern is <a href="http://msdn.microsoft.com/en-us/library/windows/apps/br211866.aspx">in the WinJS promise implementation</a>. Before that, promise libraries used an awkward concept called a &ldquo;deferred.&rdquo; You would do something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>

<span class="c1">// Use `deferred.resolve` to resolve `p`.</span>
<span class="c1">// Use `deferred.reject` to reject `p`.</span>

<span class="nx">doThingsWith</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
</code></pre></figure>

<p>This was strange in a few ways, but most prominently, it was strange because you were constructing an object without using a constructor. This is generally an antipattern in JavaScript: we want to be able to clearly conceptualize the relationship between instances, constructor functions, and prototypes.</p>

<p>In contrast, with the revealing constructor pattern, we get our nice constructor invariants back. Things like:</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="nx">p</span> <span class="k">instanceof</span> <span class="nx">Promise</span><span class="p">;</span>
<span class="nx">p</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">===</span> <span class="nx">Promise</span><span class="p">;</span>
<span class="nb">Object</span><span class="p">.</span><span class="nx">getPrototypeOf</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="o">===</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
</code></pre></figure>

<p>These are all signs that you&rsquo;re dealing with a well-designed &ldquo;class&rdquo; in JavaScript, that will behave as you expect.</p>

<h2 id="the-streams-example">The Streams Example</h2>

<p>When putting together <a href="htwetps://github.com/whatwg/streams">the in-progress streams spec</a>, we of course drew a lot of inspiration from <a href="http://nodejs.org/api/stream.html">Node streams</a>. But Node streams do things kind of strangely, with regard to vending their capabilities.</p>

<p>To produce a Node stream representing a specific resource—which is somewhat analogous to producing a promise representing a specific asynchronous operation—you don&rsquo;t use the stream constructor. You don&rsquo;t even use something like the deferred pattern. Instead, you <em>subclass</em> the appropriate stream class. And then you overwrite certain underscore-prefixed methods!</p>

<p>So for a simplified example, here is how you would create a file reader stream using the Node APIs. I&rsquo;ll use ES6 class syntax for brevity, but that is just sugar over the usual ES5 incantations.</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="kr">class</span> <span class="nx">FileReaderStream</span> <span class="kr">extends</span> <span class="nx">Readable</span> <span class="p">{</span>
  <span class="nx">constructor</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">filename</span> <span class="o">=</span> <span class="nx">filename</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">_read</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Use `this.filename` to eventually call `this.push(chunk)`</span>
    <span class="c1">// with some data from the file, or `this.push(null)` to close</span>
    <span class="c1">// the stream, or `this.emit(&quot;error&quot;, e)` with an error.</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">myNodeStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReaderStream</span><span class="p">(</span><span class="s2">&quot;/path/to/file.txt&quot;</span><span class="p">);</span>
</code></pre></figure>

<p>There are two interesting actors here:</p>

<ul>
<li><code>_read</code>, a method not meant to be called by users directly, but instead called by the internals of the stream when it&rsquo;s time to read data from the underlying source.</li>
<li><code>push</code> and <code>emit(&quot;error&quot;, e)</code>, which have the capability to manipulate the stream&rsquo;s internal buffer and state machine. They too are not meant to be called by users directly, but instead only by implementers, inside their <code>_read</code> method (or perhaps inside the constructor).</li>
</ul>

<p>Interestingly, these are almost exactly analogous to the promise situation. <code>_read</code> is like the executor argment passed to the promise constructor, in that it consists of user code that does the actual work. And <code>push</code>/<code>emit</code> are capabilities, like <code>resolve</code>/<code>reject</code>, which can be used by the work-doing function to manipulate internal state.</p>

<p>In building the streams spec, we realized the Node pattern wasn&rsquo;t the way we wanted to go. Requiring subclassing for every stream instance is not ergonomic. Using underscore-prefixed methods as the extension point isn&rsquo;t realistic either. And letting any user access the capabilities involved is not tenable, in part because it means implementations can&rsquo;t build invariants around who has access to the internal buffer.</p>

<p>In contrast, the revealing constructor pattern works out really well. To create a file reader stream with whatwg/streams, you do something like</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="kd">function</span> <span class="nx">createFileReaderStream</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">ReadableStream</span><span class="p">({</span>
    <span class="nx">pull</span><span class="p">(</span><span class="nx">enqueue</span><span class="p">,</span> <span class="nx">close</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Use `filename` to eventually call `enqueue(chunk)`</span>
      <span class="c1">// with some data from the file, or `close()` to</span>
      <span class="c1">// close the stream, or `error(e)` with an error.</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">myWhatwgStream</span> <span class="o">=</span> <span class="nx">createFileReaderStream</span><span class="p">(</span><span class="s2">&quot;/path/to/file.txt&quot;</span><span class="p">);</span>
</code></pre></figure>

<p>Notice the difference in the external API exposed. If you pass <code>myNodeStream</code> to another function, that function can mess with the stream&rsquo;s internal state as much as it wants, calling <code>push</code>, emitting <code>&quot;error&quot;</code> events, or even (despite the underscore) calling <code>_read</code>. Whereas if you pass <code>myWhatwgStream</code> around, consumers will not be able to do any of those things: the integrity of its internal state will be preserved.</p>

<p>(Plus, no subclassing!)</p>

<h2 id="when-would-i-use-this?">When Would I Use This?</h2>

<p>I admit that that the revealing constructor pattern seems a bit unorthodox. The number of actors involved—viz. the constructor itself, the work-doing function to which capabilities are given, and the capability arguments—can be hard to get your head around, at least the first few times you see them.</p>

<p>That said, it is a pretty elegant solution to a tricky problem. You might not need this level of encapsulation in your home-grown code. And even more widespread libraries may be able to skate by, as Node does, with documentation strategies and an attitude of &ldquo;don&rsquo;t do anything dumb with the capabilities we leave lying around, or it&rsquo;ll break.&rdquo; But when writing platform-level libraries and abstractions, which need to maintain their integrity in the face of any environment, the revealing constructor pattern really proves its worth.</p>

<p>And besides, patterns become part of our vernacular. Many patterns that are commonplace today seemed just as strange when they are introduced as the revealing constructor pattern might to you now. After working with promises and streams for a while, you might encounter a situation where a revealing constructor is a natural fit for your library&rsquo;s needs. Who knows!</p>

<h2 id="postscript">Postscript</h2>

<p>If those examples weren&rsquo;t enough, here&rsquo;s one that you should be able to connect with: <a href="https://gist.github.com/domenic/9003334">an event emitter using the revealing constructor pattern</a>. This is an evolution of some of my <a href="https://github.com/domenic/pubit">earlier work</a> on event emitters with separate capabilities.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/continual-progress-in-the-w3c-tag/">Continual Progress in the W3C TAG</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-01T19:00:00-05:00" pubdate data-updated="true">Dec 1<sup>st</sup>, 2013</time>
        
         | <a href="/continual-progress-in-the-w3c-tag/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The W3C Technical Architecture Group has made immeasurable progress this year since
<a href="http://infrequently.org/2012/12/reforming-the-w3c-tag/">the original wave of reformist thought</a> swept through it last
election season. The extensible web agenda, which I&rsquo;ve
<a href="http://domenic.me/2013/10/07/the-extensible-web/">spoken about previously</a>, has been adopted into their vision for the
web&rsquo;s foundations and informed recent spec work across the W3C. The TAG even moved its deliverables
<a href="https://github.com/w3ctag/">onto GitHub</a>, allowing better collaboration with and transparency to developers.</p>

<p>But there&rsquo;s always more to do. The web is slowly but surely coming into its own as a serious modern development
platform—one which can compete with native apps across the board. New APIs, new primitives, and new tools are very much
necessary to make our open platform as attractive to developers and users as it could be. To lure them away from the
walled gardens of closed app stores and vendor-proprietary development platforms, we must provide something better.</p>

<p>The TAG is in a unique position to oversee these efforts, with its charter to steward the evolution of web architecture
and coordinate with other relevant groups like Ecma TC39 and the IETF. As such, I&rsquo;m excited to be
<a href="http://lists.w3.org/Archives/Public/www-tag/2013Dec/0004.html">running for TAG membership</a> in this
<a href="http://www.w3.org/blog/TAG/2013/11/06/tag-election-2013/">newest election cycle</a>.</p>

<p>Over the last year of my increasing involvement in web standards, I&rsquo;ve found two things to be paramount: <em>developer
involvement</em>, and <em>a focus on solid low-level primitives</em>. Independent of any formal role in the process, I have and
will continue to champion these causes. My nomination by the jQuery Foundation to serve on the TAG only allows me to
advocate them in a more formal role.</p>

<p>As a web developer myself, I experience the joys and disappointments of our platform every day. Some of you might think
it&rsquo;s all disappointments—and I can certainly sympathize, given our
<a href="https://twitter.com/domenic/status/403668805542354944">day-to-day frustrations</a>. But one of the more eye-opening
experiences of the last few months has been working alongside an experienced Java developer, new to the web platform,
and seeing his almost childlike glee at how <em>easy</em> it is to produce complex, interactive, and robust UIs. More
generally, when I think on what I actually do for a living at Lab49—produce complex financial trading and analysis
systems, built on the open web platform—it&rsquo;s hard not to be amazed. We&rsquo;ve come a long way from the time when only
desktop apps were considered for serious work. Now all our clients want cross-browser and cross-device web applications,
that they can access from any computer at any time, with shareable URLs and responsive experiences and all the other
things that come with the web.</p>

<p>To enable developers to build such increasingly powerful experiences, we need to listen to them. That&rsquo;s why I spend a
lot of time speaking at and traveling to developer conferences, or being involved on Twitter, on IRC, and on GitHub,
with the community. I recently gave a talk specifically on
<a href="https://www.youtube.com/watch?v=hneN6aW-d9w&amp;hd=1">how to get involved in web standards</a>, and have been working
constantly to get developer feedback on missing features or in-progress specs since then.</p>

<p>Developers are a tricky bunch, as many have been trained to ignore standards bodies and simply hack together their own
solutions. They&rsquo;re used to being ignored themselves. But times are changing. The
<a href="http://extensiblewebmanifesto.org/">extensible web manifesto</a> guides us to supply the web with the low-level features
developers need, and then to listen to them and roll what they build back into the platform. The TAG&rsquo;s role is helping
to guide this overall process, and I hope to bring along my experience listening to and learning from the developer
community.</p>

<p>You may have noticed I kept saying &ldquo;developers&rdquo; above, and never &ldquo;web developers.&rdquo; That&rsquo;s because I strongly believe we
need to look outside our own community for inspiration. There are lessons to be learned everywhere across the software
development landscape, from other UI frameworks and standard libraries, to other languages whose features we need in our
platform&rsquo;s <em>lingua franca</em> of JavaScript. Perhaps most importantly, I maintain strong ties with and involvement in the
Node.js community. They provide an excellent source of inspiration and advice, as a platform that takes JavaScript far
beyond where many of us would have envisioned it only a few years ago.</p>

<p>Which brings us to the issue of low-level primitives. Node&rsquo;s great success comes in a large part from its focus on
providing such primitives: things like standard patterns for binary data, for asynchrony, or for streaming. On top of
these they&rsquo;ve built <a href="http://nodejs.org/api/">a standard library</a> that should be the envy of any platform in both its
small size and in its power.</p>

<p>Of course, the web platform must by necessity evolve via consensus, and so more slowly than Node. But this gives us the
benefit of watching them run out ahead of us, make mistakes, and then come back with field reports on how it went. As
such we are getting typed arrays instead of buffers; promises instead of error-first callbacks; and
<a href="https://github.com/whatwg/streams/">intelligently-designed streams</a> instead of backward-compatible evolved ones. And
it&rsquo;s no coincidence that I&rsquo;ve been involved in both the promises and streams efforts, as I&rsquo;m very passionate about
ensuring that these foundational pieces of the platform are solid enough to build on and have learned from experiences
implementing them elsewhere.</p>

<p>But we&rsquo;re still in our infancy when it comes to building on these primitives. We need to tie them together with the rest
of the web platform. In short, we need to get to the day when the</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;http://example.com/video.mp4&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">videoProcessingWebWorker</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s2">&quot;video&quot;</span><span class="p">))</span>
</code></pre></figure>

<p><a href="https://github.com/whatwg/streams/blob/master/Requirements.md#you-must-be-able-to-transform-streams-via-the-pipe-chain">example</a>
is not just a dream, but is reality.</p>

<p>In my view, it&rsquo;s the TAG&rsquo;s job to get us there. The cross-group coordination issues necessary to make visions like this
a reality are a large part of the TAG&rsquo;s charter. We can provide a high-level vision, fueled by our interaction with the
developer community, for extending the web forward. And all the while, I&rsquo;ll be down in the trenches, both gathering
feedback to help shape this vision, and working on specifications and interfacing with implementers to make it happen.</p>

<p>If this sounds like progress to you, I&rsquo;d appreciate your organization&rsquo;s vote.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/the-extensible-web/">The Extensible Web</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-06T20:00:00-04:00" pubdate data-updated="true">Oct 6<sup>th</sup>, 2013</time>
        
         | <a href="/the-extensible-web/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>This post adapts <a href="http://2013.jsconf.eu/speakers/#/speakers/domenic-denicola-the-extensible-web-javascript-all-the-way-down">my talk from JSConf EU 2013</a>.</em></p>

<p>The web platform has, historically, been somewhat of a kludge. It&rsquo;s grown, organically, into something with no real
sense of cohesion. Most of its APIs have been poorly designed, by C++ developers, via
<a href="http://www.omg.org/gettingstarted/omg_idl.htm">a binding layer meant originally for CORBA</a>.</p>

<p>Worse, there have been major gaps in what we can do compared to native apps. And for those things that we can do, we end
up accomplishing them by drowning ourselves in custom JavaScript functionality.</p>

<p>The problem is in the process. Generally, new things have been introduced into our web platform via a months or years of
mailing-list standardization, writing something in prose and IDL, driven by scenario-solving—without much concern for
actual utility, much less usability. Implementers expose some fundamental capability in terms of a high-level API or
declarative form that burrows down directly to the C++ layer, giving you limited customizability. After all this time,
it eventually ends up in your hands, and you end up telling the standards bodies that <a href="https://dvcs.w3.org/hg/IndexedDB/raw-file/default/Overview.html">it&rsquo;s a huge mess</a>, or
that <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/offline.html">it solves half of your problems half of the time</a>.</p>

<p>Despite all this, we&rsquo;ve somehow done OK. Actually, a bit more than OK, given that the web is the most successful
platform ever. How did we manage this?</p>

<p>Well, we wrap up APIs with horrible usability into ones that are quite pleasant, like jQuery. We &ldquo;prolyfill,&rdquo; creating
libraries like Sizzle to implement CSS selector matching, or libraries like Angular to implement custom elements, in the
hope that eventually native support will appear. We transpile from languages like CoffeeScript or SASS to add new
features to our authoring languages. And one case, promises, we even
<a href="http://www.slideshare.net/domenicdenicola/boom-promisesa-was-born">built an interoperable standard from the ground up</a>.</p>

<p>We need our platform to be better, and so we <em>make</em> it better, by ourselves.</p>

<h2 id="the-extensible-web-manifesto">The Extensible Web Manifesto</h2>

<p>The <a href="http://extensiblewebmanifesto.org/">Extensible Web Manifesto</a> is standards bodies saying they&rsquo;re ready to do
their part. Until now, we, the developers, have been shouldering all the work, writing massive JavaScript libraries or
transpilers to reinvent basic functionality.</p>

<p>There&rsquo;s a better way, where we work together toward the future.</p>

<p>What these standards bodies have realized is that the web platform is our language, but like all languages, it must
evolve.</p>

<p>This evolution of our shared language takes place in two acts:</p>

<ol>
<li>extending our basic vocabulary;</li>
<li>starting to <a href="http://briankardell.wordpress.com/2013/05/17/dropping-the-f-bomb/">incorporate &ldquo;slang&rdquo;</a>.</li>
</ol>

<h2 id="extending-our-vocabulary">Extending our Vocabulary</h2>

<p>Extending our vocabulary means two things:</p>

<ul>
<li><p><em>Explaining the features of the platform that are already there.</em> Wouldn&rsquo;t it be weird if we had compound words like
&ldquo;scifi,&rdquo; but didn&rsquo;t have the words &ldquo;science&rdquo; or &ldquo;fiction&rdquo;? If some standards body, perhaps the
<a href="https://en.wikipedia.org/wiki/Acad%C3%A9mie_fran%C3%A7aise">French Making Up Words Consortium</a>, just handed us the
word &ldquo;sandpaper,&rdquo; but we had no way in our language to talk about &ldquo;sand&rdquo; or &ldquo;paper&rdquo; individually? The web is like
that today, and we&rsquo;ll go over a few examples.</p></li>
<li><p><em>Giving you new low-level features that you can use</em>. If you wanted to invent the word &ldquo;scifi,&rdquo; somebody had better
have come up with the words for &ldquo;science&rdquo; and &ldquo;fiction&rdquo;! Similarly, there&rsquo;s lots of things we just don&rsquo;t have &ldquo;words&rdquo;
for on the web, yet. That&rsquo;s where native apps are hurting us.</p></li>
</ul>

<p>So with this in mind, let&rsquo;s look at some examples.</p>

<h3 id="custom-elements">Custom Elements</h3>

<p>The most fundamental unexplained gap in the platform is simply: how do those damn elements even work?</p>

<p>Somehow, you feed a string containing some angle brackets into the browser, and they get turned into these JS objects
with terrific APIs, which we call &ldquo;the DOM.&rdquo; How did that happen?</p>

<p><a href="https://dvcs.w3.org/hg/webcomponents/raw-file/default/spec/custom/index.html">Custom elements</a> explain this process,
saying that you register a mapping of tag names to element prototypes with the browser, and that&rsquo;s what the HTML parser
is actually using under the hood. This is great! This is the democratization of HTML!</p>

<p>And better yet, this means no more crazy widget libraries with their own crazy semantics. No more jQuery UI with its
<code>.option</code> thing (sometimes a setter, sometimes a getter, sometimes a method call); no more Dojo digits; no more
Bootstrap craziness; no more WinJS with its funky <code>winControl</code> property. Just tags, that turn into elements, which
behave like you&rsquo;d expect: they have properties, getters, setters, methods, and all that.</p>

<h3 id="the-shadow-dom">The Shadow DOM</h3>

<p>But what about the existing tags? Half of the reason these widget libraries exist is so that you can create your own
stupid <code>&lt;select&gt;</code> element, because the existing one isn&rsquo;t styleable or customizable.</p>

<p>In general, think of all the &ldquo;magic&rdquo; tags that exist today, like <code>&lt;select&gt;</code>, or <code>&lt;input type=&quot;date&quot;&gt;</code>, or <code>&lt;details&gt;</code>,
or <code>&lt;video&gt;</code>, or even good old <code>&lt;li&gt;</code>, whose bullet seems to come out of nowhere. In all cases, there&rsquo;s some extra
&ldquo;stuff&rdquo; the browser is creating, and allowing users to interact with, and sometimes even allowing you to style via
ridiculous vendor-prefixed pseudo-elements like <code>::-moz-placeholder</code>. But where does this extra stuff live?</p>

<p>The answer is: in the <a href="https://dvcs.w3.org/hg/webcomponents/raw-file/tip/spec/shadow/index.html">shadow DOM</a>. And what&rsquo;s
great about the shadow DOM, is that once we actually have a realistic basis for these hidden parts of the DOM, in
reality instead of in C++ magic-land, you&rsquo;ll be able to actually start hooking into them instead of rebuilding an entire
element just to customize its behavior and styling. That day is
<a href="https://groups.google.com/a/chromium.org/d/msg/blink-dev/ZAdZJWahyF8/lOInKCTbmrUJ">almost here</a>.</p>

<h3 id="web-audio">Web Audio</h3>

<p>The <a href="https://dvcs.w3.org/hg/audio/raw-file/tip/webaudio/specification.html">web audio API</a> is a good example of both
facets of the &ldquo;new vocabulary&rdquo; theme. You can do fundamentally new things with web audio, like positional audio or audio
synthesis or so many other cool possibilities.</p>

<p>But remember the <code>&lt;audio&gt;</code> tag, from way back in 2009? It&rsquo;s kind of the quintessential instance of &ldquo;here&rsquo;s some C++
magic thrown over the wall to you web developers; have fun!&rdquo; Well, from an extensible web perspective, the <code>&lt;audio&gt;</code> tag
should be explained in terms of web audio.</p>

<h3 id="etcetera">Etcetera</h3>

<p>There are of course many other APIs which exist solely to expose a new low-level hardware or platform feature to the web
platform. One of the older examples on the hardware side is the
<a href="http://www.w3.org/TR/geolocation-API/">geolocation API</a>. On the software side, good examples include the
<a href="http://notifications.spec.whatwg.org/">notifications API</a> and <a href="http://fullscreen.spec.whatwg.org/">fullscreen API</a>. But
more and more are popping up as we attempt to close all the gaps preventing full parity with native apps; one particular
driver of this is the work on Firefox OS and the related <a href="http://www.w3.org/2009/dap/">device APIs</a>.</p>

<h3 id="es6-and-es7">ES6 and ES7</h3>

<p>Finally, I want to call out ECMAScript 6 (which is nearing finalization) and ECMAScript 7 (for which efforts are just
starting to ramp up). Extending the web&rsquo;s programming language is adding new vocabulary at its most literal level, and
the TC39 committee driving the evolution of ECMAScript does not disappoint in their efforts here.</p>

<p>In ES6 we&rsquo;ll be getting subclassable built-in objects, so that you can finally extend <code>Array</code> or <code>Date</code> or the new <code>Map</code>
and <code>Set</code> types, in a way that actually works. We&rsquo;ll also be getting proxies, which allow an object almost-complete
control over the meta-object protocol underlying all interactions with it. And for ES7, the proposal for
<code>Object.observe</code> is starting to firm up. Plus there is talk of adding weak references to the language, now that some of
their trickier aspects have been worked out.</p>

<h2 id="incorporating-slang">Incorporating Slang</h2>

<p>The second half of the extensible web philosophy is that we need to tighten the feedback loop between developers and
standards bodies.</p>

<p>Think about it: you get all these neat new low-level tools, and you build great things out of them. But you end up
downloading megabytes of JavaScript, or transpiling your code, just to get the base platform in place. This is why
almost every web page uses jQuery: because the platform itself hasn&rsquo;t stepped up to the plate and incorporated jQuery&rsquo;s
innovations back in.</p>

<p>In short, we need to incorporate this kind of invented &ldquo;slang&rdquo; back into our shared language. Let&rsquo;s take a look at some
of the examples of this so far.</p>

<h3 id="&lt;template&gt;"><code>&lt;template&gt;</code></h3>

<p>The <a href="http://www.html5rocks.com/en/tutorials/webcomponents/template/"><code>&lt;template&gt;</code> element</a> is a generalization of the
common <code>&lt;script type=&quot;text/x-template&quot;&gt;</code> trick. By rolling it into the browser, additional benefits can be realized,
allowing the template tree to be treated as an inert version of a real DOM tree, and for the element parsing and
serialization rules to specifically call out templating use cases.</p>

<h3 id="&lt;dialog&gt;"><code>&lt;dialog&gt;</code></h3>

<p>The <a href="http://developers.whatwg.org/commands.html#the-dialog-element"><code>&lt;dialog&gt;</code> element</a> obviates all of the annoying
dialog or &ldquo;lightbox&rdquo; libraries we keep having to ship, each with their own strange semantics. Instead, it&rsquo;s a simple
tag, with some imperative APIs, some declarative features, and a nice <code>::backdrop</code> pseudo-element. Sweet!</p>

<h3 id="css-improvements">CSS Improvements</h3>

<p>CSS is slowly but surely starting to roll in innovations from SASS and elsewhere.
<a href="http://dev.w3.org/csswg/css-hierarchies/">CSS hierarchies</a>, still under development, brings SASS&rsquo;s nested selectors to
the browser. <a href="http://dev.w3.org/csswg/css-variables/">CSS variables</a> uses a clever trick to get something with the same
benefits as the variables in SASS and others, but fitting in well with CSS&rsquo;s existing semantics. And
<a href="http://dev.w3.org/csswg/css-cascade/">CSS cascade</a> introduces the <code>unset</code> keyword which reduces all those complicated
CSS reset stylesheets rules to virtually nothing.</p>

<h3 id="pointer-events">Pointer Events</h3>

<p><a href="https://dvcs.w3.org/hg/pointerevents/raw-file/tip/pointerEvents.html">Pointer events</a> finally unify mouse and touch
events into a single abstraction. In one stroke, this obviates many libraries built to work around this strange
dichotomy introduced by mobile Safari, and around other strangeness relating to trying to use mouse events on a touch
device. They will be a welcome addition to the web platform.</p>

<h3 id="promises">Promises</h3>

<p>When a pattern is adopted by jQuery, Dojo, Angular, Ember, WinJS, and YUI, as well as many other popular dedicated
libraries, it&rsquo;s time to put it into the platform. <a href="https://github.com/domenic/promises-unwrapping">Promises</a> are on
track for ES6, and are being added to browsers now.</p>

<h2 id="what&#39;s-next?">What&rsquo;s Next?</h2>

<p>The extensible web is an ongoing project, and several efforts are being headed up to expose even more capabilities to
developers, or roll even more common patterns into the platform. Here&rsquo;s a brief taste of those I&rsquo;m watching closely.</p>

<h3 id="streams">Streams</h3>

<p><code>FileReader</code>, <code>XMLHttpRequest</code>, <code>getUserMedia</code>, <code>postMessage</code>, object URLs, <code>MediaStream</code>s… As
<a href="http://imgur.com/a/9vFGa#11">poignantly emphasized</a> in a brilliant presentation by Max Ogden, we&rsquo;re clearly missing a
unifying abstraction here, and that abstraction is streams.</p>

<p>Node.js has led the way with their battle-tested implementations, but they&rsquo;ve also learned some lessons we should be
sure to heed in order to design a good browser stream API. In the end, the goal is to be able to take various sources of
binary data (HTTP requests, camera data, payloads stored in IndexedDB, the output of a web audio graph, …) and pipe them
into various sinks (<code>&lt;img&gt;</code>, <code>&lt;video&gt;</code>, and <code>&lt;audio&gt;</code> tags; other windows, frames, or workers; filesystem or remote HTTP
endpoints; or completely custom consumption code). It&rsquo;s going to be really cool, but we have some work to do before we
get something as well-designed as promises were.</p>

<h3 id="fetch">Fetch</h3>

<p>The basic act of doing an HTTP request has so much complexity on the web platform: cross-domain protection; redirect
following; deserialization from bytes; cookie jars; caches… We want to provide the basic building block, and then the
ability to layer and compose each of these features on top of it.</p>

<h3 id="zip/zlib">ZIP/ZLib</h3>

<p>There&rsquo;s active investigation going on into how to expose compression primitives to the web. This is clearly something
where native bindings will be more performant, and although there are
<a href="https://github.com/imaya/zlib.js">impressive polyfills</a>, native APIs, preferably with asynchronous off-main-thread
compression, will enable new scenarios. This work is in its early stages, so if you want to get involved, reach out.</p>

<h3 id="class-elements-extends-array"><code>class Elements extends Array</code></h3>

<p>My personal favorite new feature is the upcoming
<a href="http://dom.spec.whatwg.org/#collections:-elements"><code>Elements</code> collection</a>. It&rsquo;s a proper array subclass, using the
aforementioned ES6 subclassable builtin support, to give you something where you can <em>finally</em> use <code>forEach</code>, <code>reduce</code>,
<code>filter</code>, and all your favorite methods.</p>

<p>As part of this effort we added two methods, <code>query</code> and <code>queryAll</code>, to both <code>Element.prototype</code> and to
<code>Elements.prototype</code>. They act as better versions of <code>querySelector</code> and <code>querySelectorAll</code>, in that they treat relative
selectors like <code>&quot;&gt; div&quot;</code> the way you would expect instead of throwing an error. The versions on <code>Elements.prototype</code> act
as composite operations over all elements in the collection, just like in jQuery.</p>

<p>This is the beginning of a new, friendlier DOM, and I&rsquo;m pretty excited about it.</p>

<h3 id="what-else?">What Else?</h3>

<p>What do we need? What is preventing you from building the web apps of your dreams? You tell us! The extensible web is
waiting for your participation!</p>

<h2 id="getting-involved">Getting Involved</h2>

<p>The best thing you can do to get involved in the extensible web is <em>prolyfill</em>. There&rsquo;s only so much standardization
bandwidth to go around, so if you can create a de-facto standard like jQuery, or an open specification with wide
implementer suppport like Promises/A+, the world is waiting.</p>

<p>For example, if you wanted to figure out what a zlib API for the browser should look like, the best thing you can do is:</p>

<ul>
<li>Learn what the constraints and use cases are. (And not just your use cases, but everyone&rsquo;s!)</li>
<li>Design an API and library to prolyfill this gap.</li>
<li>Evangelize its use among developers, so that everyone recognizes it as the clear solution that browsers should just
ship and be done with it.</li>
</ul>

<p>More generally, if you want to be involved in helping the web succeed by guiding us toward better standards, then let&rsquo;s
talk. It&rsquo;s an area I&rsquo;ve been diving into over the last year, stemming from my Promises/A+ work but expanding into many
other things. Finding the right approach and content is delicate, as these people are jaded by newbies coming out of the
woodwork to demand feature X. But if you approach in good faith and avoid a prideful demeanor, they&rsquo;re often happy to
listen. I&rsquo;ve had a few success stories in this area already, and by this time next year I want to have a lot more.</p>

<p>In fact, I gave a talk on this subject at LXJS, titled
<a href="https://www.youtube.com/watch?v=hneN6aW-d9w&amp;hd=1">&ldquo;How to Win Friends and Influence Standards Bodies&rdquo;</a>. I&rsquo;ll probably
be adapting it into blog post form soon.</p>

<p>Another thing I wanted to note, before closing out, is that this extensible web philosophy has teeth. The W3C Technical
Architecture Group had four seats go up for reelection recently. Four &ldquo;reformers&rdquo; were elected at once: Yehuda Katz,
Alex Russell, Marcos Caceres, and Anne van Kesteren. The extensible web philosophy underlies their governance, as the
ultimate technical body which provides guidance and approval for all W3C specs. We&rsquo;ve already seen fruit here with their
<a href="https://github.com/w3ctag/spec-reviews/blob/master/2013/07/WebAudio.md">review of the web audio spec</a>,
<a href="https://github.com/w3ctag/spec-reviews">among others</a>. They&rsquo;ve been helping specs build on a solid grounding in
JavaScript fundamentals, and generally be less magic and more JavaScript. All their work is being done
<a href="https://github.com/w3ctag">on GitHub</a>, as are more and more specifications. This is happening!</p>

<p>To close, I&rsquo;d like to give a short message of hope. It&rsquo;s easy to think about all these cool things that are coming, and
then get depressed about having to support IE8 or Android 2.3 at your job. But that&rsquo;s the price we pay for an open,
interoperable web. We can&rsquo;t just march to the tune of a single vendor, upgrading in lockstep. Instead we work through
this collaborative, cooperative process, to build our shared language. In the end, <em>the future is longer than the past</em>,
and I look forward not only to living in that future, but to helping shape it, together with you all.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/es6-iterators-generators-and-iterables/">ES6 Iterators, Generators, and Iterables</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-05T20:00:00-04:00" pubdate data-updated="true">Sep 5<sup>th</sup>, 2013</time>
        
         | <a href="/es6-iterators-generators-and-iterables/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I wrote up a quick guide to the terminology around ES6&rsquo;s iteration-related concepts, plus some notes and other
resources.</p>

<h2 id="definitions">Definitions</h2>

<p>An <strong>iterator</strong> is an object with a <code>next</code> method that returns <code>{ done, value }</code> tuples.</p>

<p>An <strong>iterable</strong> is an object which has an internal method, written in the current ES6 draft specs as
<code>obj[@@iterator]()</code>, that returns an iterator.</p>

<p>A <strong>generator</strong> is a specific type of iterator whose <code>next</code> results are determined by the behavior of its corresponding
generator function. Generators also have a <code>throw</code> method, and their <code>next</code> method takes a parameter.</p>

<p>A <strong>generator function</strong> is a special type of function that acts as a constructor for generators. Generator function
bodies can use the contextual keyword <code>yield</code>, and you can send values or exceptions into the body, at the points where
<code>yield</code> appears, via the constructed generator&rsquo;s <code>next</code> and <code>throw</code> methods. Generator functions are written with
<code>function*</code> syntax.</p>

<p>A <strong>generator comprehension</strong> is a shorthand expression for creating generators, e.g.
<code>(for (x of a) for (y of b) x * y)</code>.</p>

<h2 id="notes">Notes</h2>

<h3 id="for-of"><code>for</code>-<code>of</code></h3>

<p>The new <code>for</code>-<code>of</code> loop works on iterables, i.e. you do <code>for (let x of iterable) { /* ... */ }</code>. So for example, it
works on arrays by looking up their <code>Array.prototype[@@iterator]()</code> internal method, which is specified to return an
iterator that does what you&rsquo;d expect. Similarly <code>Map.prototype</code>, <code>Set.prototype</code>, and others all have <code>@@iterator</code>
methods that help them work with <code>for</code>-<code>of</code> and other constructs in the language that consume iterators.</p>

<p>Note that <code>for</code>-<code>in</code> has nothing to do with iterables, or indeed any of the concepts discussed here. It still works as
it did before, looping through enumerable object properties, and it will be pretty useless when given an iterable of any
sort.</p>

<h3 id="iterable-iterators">Iterable Iterators</h3>

<p>An <em>iterator</em> can also be <em>iterable</em> if it has an <code>@@iterator()</code> internal method. Most iterators in the ES6 draft spec
are also iterable, with the internal method just returning <code>this</code>. In particular, all generators created via generator
functions or generator comprehensions have this behavior. So you can do:</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="kr">const</span> <span class="nx">lazySequence</span> <span class="o">=</span> <span class="p">(</span><span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="nx">of</span> <span class="nx">a</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="nx">y</span> <span class="nx">of</span> <span class="nx">b</span><span class="p">)</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">y</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">z</span> <span class="nx">of</span> <span class="nx">lazySequence</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">z</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></figure>

<h3 id="making-iterable-objects">Making Iterable Objects</h3>

<p>To make a custom iterable object, you use the <code>Symbol.iterator</code> symbol, which is the inside-JavaScript way of referring
to the specification&rsquo;s <code>@@iterator</code>. It should return an iterator, thus making your object iterable. The easiest way to
write the iterator-returning method is to use generator syntax. Putting this all together, it looks like</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="kr">const</span> <span class="nx">iterable</span> <span class="o">=</span> <span class="p">{</span>
  <span class="o">*</span><span class="p">[</span><span class="nx">Symbol</span><span class="p">.</span><span class="nx">iterator</span><span class="p">]()</span> <span class="p">{</span>
    <span class="nx">yield</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">yield</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nx">yield</span> <span class="mi">3</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">x</span> <span class="nx">of</span> <span class="nx">iterable</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></figure>

<h3 id="generator-comprehension-desugaring">Generator Comprehension Desugaring</h3>

<p>You can think of generator comprehensions as &ldquo;sugar&rdquo; for writing out and immediately invoking a generator function, with
<code>yield</code>s inserted implicitly at certain points. For example, the comprehension <code>(for (x of a) for (y of b) x * y)</code>
desugars to</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="p">(</span><span class="kd">function</span><span class="o">*</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="nx">of</span> <span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">y</span> <span class="nx">of</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">yield</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">y</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}())</span>
</code></pre></figure>

<h3 id="a-weirdness">A Weirdness</h3>

<p>It&rsquo;s not entirely clear why generator comprehensions create generators instead of simple iterable-iterators. In
particular, as you can see from the above desugaring, calling <code>throw</code> or giving a parameter to <code>next</code> is pretty useless:</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="kr">const</span> <span class="nx">g</span> <span class="o">=</span> <span class="p">(</span><span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="nx">of</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">);</span>

<span class="nx">g</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>                   <span class="c1">// returns { done: false, value: 1 }</span>
<span class="nx">g</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>                  <span class="c1">// returns { done: false, value: 2 }</span>
<span class="nx">g</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;boo!&quot;</span><span class="p">));</span> <span class="c1">// immediately throws the error</span>
</code></pre></figure>

<p>It seems the arguments in favor of generators instead of iterable-iterators are largely that it makes implementers&#39; jobs
easier, at least according to
<a href="http://esdiscuss.org/topic/why-do-generator-expressions-return-generators">this es-discuss thread</a> I started.</p>

<h2 id="implementation-status">Implementation Status</h2>

<p>Due to the tireless work of <a href="http://wingolog.org/">Andy Wingo</a>, V8 (Chrome) has support for generator functions, behind
the <code>--harmony</code> flag (or &ldquo;Experimental JavaScript Features&rdquo; in chrome://flags). It also has some form of <code>for</code>-<code>of</code>,
which only works with generators and with the custom iterables returned by <code>Array.prototype.values</code> and
<code>Array.prototype.keys</code>, but does not work with anything else (e.g. arrays themselves). I assume this is because the
iteration protocol has not been implemented yet. V8 does not have generator comprehensions.</p>

<p>SpiderMonkey (Firefox) has an old version of everything here, with outdated syntax and semantics. Over the last week or
so, Andy has submitted patches to update their generator implementation. He&rsquo;s now working on <code>for</code>-<code>of</code> and the
iteration protocol in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=907077">bug #907077</a>; no word on generator
comprehensions. Note that SpiderMonkey, unlike V8, does not hide these features behind a default-off flag.</p>

<p>Chakra (Internet Explorer) is as always a complete mystery, with no transparency into their development cycle or even
priority list.</p>

<p>And I still haven&rsquo;t forgiven JavaScriptCore (Safari) for its long period of forgetting to implement
<code>Function.prototype.bind</code>, so I haven&rsquo;t even tried looking into their status.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/explaining-away-the-webs-magic/">Explaining Away the Web&#8217;s Magic</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-09T20:00:00-04:00" pubdate data-updated="true">Jun 9<sup>th</sup>, 2013</time>
        
         | <a href="/explaining-away-the-webs-magic/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today we revealed <a href="http://extensiblewebmanifesto.org/">The Extensible Web Manifesto</a>, calling for a new approach to
web standards that prioritizes new local-level capabilities in order to explain and extend higher-end platform features.
I want to take a minute to talk about what this means in practice, and why it&rsquo;s different from how we operate today.</p>

<h2 id="show-me-the-magic!">Show Me the Magic!</h2>

<p>The core of the extensible web manifesto says two things:</p>

<ul>
<li>We should <em>expose new low-level capabilities</em> to JavaScript</li>
<li>We should <em>explain existing high-level features</em> in terms of JavaScript</li>
</ul>

<p>The first of these is fairly obvious, but important. It&rsquo;s this goal that has brought us things that were previously
restricted to native apps or Flash, e.g. webcam and geolocation access, or WebGL. Even something as simple as the page
visibility API is a nice, low-level capability that helps us build our apps in ways we couldn&rsquo;t do before.</p>

<p>What all of these low-level APIs have in common is that they&rsquo;re exposing &ldquo;C++ magic&rdquo; to us, the web developers. They&rsquo;re
bridging the gap between native hardware and OS capabilities, into the realm of web applications. This is good. This is
where the magic belongs: where our technology fails us.</p>

<p>The second point is where things get subtle. Because it turns out there&rsquo;s a lot more C++ magic going on in your browser
than just access to hardware, or to OpenGL bindings. Arguably the biggest amount of magic in the web platform is the
magic we take for granted: the magic that translates declarative HTML and CSS into what we see on the screen and
manipulate with JavaScript.</p>

<p>This is the more revolutionary part of the extensible web manifesto. It&rsquo;s drawing a line in the sand and saying: <strong>the
C++ magic stops here</strong>. We need to stop building high-level features of the platform out of magic when it&rsquo;s not
necessary to do so, and we need to explain the existing features in terms of JavaScript technology—not C++ magic—at
least until we bottom out at the low-level hardware capabilities discussed above. By taking this stand, we enable users
to extend the web platform without rebuilding it from scratch.</p>

<h2 id="#extendthwebforward-in-practice">#extendthwebforward In Practice</h2>

<p><strong>Custom tags</strong> are a great example of this principle in action. If you stick to a pre-defined list defined by the W3C,
then you can use your declarative HTML all over the place. Each tag gets turned into its own JavaScript counterpart via
the parser, whether it be the humble transformation of <code>&lt;p&gt;</code> into <code>HTMLParagraphElement</code> or the complex wirings between
<code>&lt;img&gt;</code> and <code>HTMLImageElement</code>.</p>

<p>Everything the W3C doesn&rsquo;t know about, however, gets turned into the featureless blob that is <code>HTMLUnknownElement</code>. Hrm.</p>

<p>There&rsquo;s clearly a lot of magic going on here, most of it encapsulated in that &ldquo;parser&rdquo; thing. What if the parser was
extensible, and could be explained in terms of a JavaScript API? What if we pushed the magic further back? A good first
step might be allowing
<a href="http://www.polymer-project.org/platform/custom-elements.html">the registration of custom elements</a>. That way, we could
explain the inner workings of this magic parser in terms of how it looks up an element name in a registry, and then
derives instances from that registry. This has a wonderful emergent property as well: now that HTML elements are
explained by a C++ parser turning HTML into JavaScript, our JavaScript objects can use the usual mechanisms of the
language, like prototypal inheritance and constructors, to build on existing HTML elements.</p>

<p>The <strong>shadow DOM</strong> is another of my favorite examples. While <code>&lt;p&gt;</code> might be a relatively non-magical element, clearly
there&rsquo;s a lot of crazy stuff going on with <code>&lt;select&gt;</code>! And don&rsquo;t get me started on <code>&lt;audio&gt;</code> and <code>&lt;video&gt;</code>. It&rsquo;s as if
there&rsquo;s a whole, um, shadow DOM, hidden underneath the one we see, accessible only by C++. The goal of the shadow DOM
spec, going back to its <a href="http://glazkov.com/2011/01/14/what-the-heck-is-shadow-dom/">earliest conception</a>, has been to
bring that magic out of C++ and explain it in terms of
<a href="http://www.html5rocks.com/en/tutorials/webcomponents/shadowdom/">JavaScript primitives</a>.</p>

<p>But it&rsquo;s not just these large examples, attempting to explain HTML. What about something as simple as … <strong>parsing
URLs</strong>? Clearly, the platform has this capability:</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">);</span>
<span class="nx">a</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s2">&quot;http://infrequently.org/2012/04/bedrock/#comments&quot;</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">protocol</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">pathname</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">hash</span><span class="p">);</span>
</code></pre></figure>

<p>But somehow, this capability got tied up inside the high-level abstraction of the <code>&lt;a&gt;</code> element, and isn&rsquo;t accessible
to us directly as JavaScript programmers. We&rsquo;re left reimplementing it, often
<a href="https://github.com/joyent/node/issues/5452">incorrectly</a>, on our own. It&rsquo;s this kind of travesty that work like
<a href="http://url.spec.whatwg.org/#constructors">the URL spec</a> in particular, and the extensible web movement in general, is
trying to prevent.</p>

<p>Let&rsquo;s keep going. What does this do?</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="kd">var</span> <span class="nx">els</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s2">&quot;:enabled&quot;</span><span class="p">);</span>
</code></pre></figure>

<p>Well, hmm, something about <a href="http://www.w3.org/TR/css3-selectors/#enableddisabled">&ldquo;an enabled state&rdquo;</a>. I wonder what
that means. Probably something to do with
<a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/association-of-controls-and-forms.html#enabling-and-disabling-form-controls:-the-disabled-attribute">the <code>disabled</code> attribute</a>. How did the browser know that? More magic! We passed in a string that&rsquo;s in a magic
list called &ldquo;CSS3 selectors spec,&rdquo; and it has some magic handler that turns that into &ldquo;elements where
<code>el.disabled === false</code>.&rdquo; This is a pretty high-level abstraction; could we explain it with technology instead of magic?
What about some kind of <strong>CSS selector registration</strong>?</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="nb">document</span><span class="p">.</span><span class="nx">registerSelector</span><span class="p">(</span><span class="s2">&quot;:enabled&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!</span><span class="nx">el</span><span class="p">.</span><span class="nx">disabled</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></figure>

<p>It&rsquo;s of course more complicated than that. To make this performant and sensible, we&rsquo;re going to need some way to ensure,
or at least assume, that the function passed is pure (i.e. side-effect free and gives the same answers to the same
inputs). But we <a href="http://wiki.ecmascript.org/doku.php?id=strawman:data_parallelism">need something like that anyway</a>.
It&rsquo;ll happen.</p>

<p>There&rsquo;s so many more examples. Once you start seeing the web browser in this way, trying to pick apart and explain its
C++ magic in terms of JavaScript technology, you&rsquo;ll have a hard time un-seeing how much work needs to be done. Here&rsquo;s
just a brief scratchpad idea list:</p>

<ul>
<li><a href="https://gist.github.com/wycats/cf73dd4c974352fcb767">Low-level HTTP fetching and data streams</a></li>
<li>More general and composable binary data streams, <a href="http://imgur.com/a/9vFGa#11">à la Node.js</a></li>
<li><a href="http://www.polymer-project.org/platform/web-animations.html">Unified animations primitives</a></li>
<li><a href="https://github.com/slightlyoff/NavigationController/blob/master/explainer.md">A way of responding to requests when your app is offline</a></li>
<li>Exposed GZIP capabilities</li>
<li>Custom scrollbars</li>
<li>Custom tooltips</li>
<li><a href="http://davidwalsh.name/html5-context-menu">Custom context menus</a></li>
<li><a href="http://lists.w3.org/Archives/Public/www-dom/2013AprJun/0188.html">Deferred, but synchronous, exception handling</a></li>
<li><a href="http://updates.html5rocks.com/2012/11/Respond-to-change-with-Object-observe">Observing and responding to changes to JS objects</a></li>
</ul>

<h2 id="what&#39;s-next">What&rsquo;s Next</h2>

<p>The extensible web manifesto was a statement of intent, and of prioritization.</p>

<p>Some of the reaction to it has been along the lines of &ldquo;Well … duh!?&rdquo; To which I reply: exactly! This <em>should</em> be obvious. But if you look at how the standards process has worked
<a href="https://medium.com/the-future-of-the-web/2fcd1c1bb32">historically</a>, that&rsquo;s not what happened. Implementers handed down
new high-level solutions from their ivory towers, <a href="http://news.cnet.com/8301-17939_109-10281477-2.html">without knowing</a>
if they actually solved the problems we as developers actually had. Or they knew we needed some primitive, but gave us
<a href="http://updates.html5rocks.com/2013/03/What-s-the-CSS-scope-pseudo-class-for">a slightly messed-up version of it</a>, due
to lack of attention to common use cases. It&rsquo;s been somewhat tragic, actually.</p>

<p>The publication of the extensible web manifesto is taking a stand for a process that should help avoid these missteps,
by doing what we should have been doing all along. In short, <em>prioritize efforts to expose low-level tools</em>; then,
watch what the developer community converges on and fold that back into the web platform <em>now that we know it solves
common high-level use cases</em>. And this ideology has teeth: the W3C&rsquo;s newly-reformed
<a href="http://www.w3.org/2001/tag/2013/03/18-agenda">Technical Architecture Group</a> has taken on the case of overseeing this
effort, ensuring that new APIs are introduced to explain away the C++ magic in terms of idiomatic JavaScript.</p>

<p>This is something I can get behind.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/strict-mode-static-scoping/">Strict Mode = Static Scoping</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-18T20:00:00-04:00" pubdate data-updated="true">Mar 18<sup>th</sup>, 2013</time>
        
         | <a href="/strict-mode-static-scoping/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It is indeed
<a href="http://www.nczonline.net/blog/2012/03/13/its-time-to-start-using-javascript-strict-mode/">time to start using JavaScript&rsquo;s strict mode</a>.
There are many reasons, but one of the most compelling is that it brings sanity to JavaScript&rsquo;s scoping rules, by
guaranteeing static scoping.</p>

<p>Simply put, code is <em>statically scoped</em> if you can statically analyze it and determine what all the identifiers refer
to. In other words, you can statically determine where every variable was declared. As we&rsquo;ll see, JavaScript&rsquo;s sloppy
mode does not have this property, giving you yet one more reason to shun it in favor of <code>&quot;use strict&quot;</code>.</p>

<h2 id="sloppy-mode-=-dynamic-scoping">Sloppy Mode = Dynamic Scoping</h2>

<p>Most of the time, JavaScript scoping is fairly simple. You look up the scope chain, as declared in the source code; if
you can&rsquo;t find something, it must be on the global object. But in sloppy mode, there are several situations that can
foil this algorithm.</p>

<h3 id="use-of-with">Use of <code>with</code></h3>

<p>Using the <code>with</code> statement completely destroys the sanity of your scope chain:</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="kd">var</span> <span class="nx">__filename</span> <span class="o">=</span> <span class="s2">&quot;/my/cool/file.js&quot;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">anotherContext</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">__filename</span><span class="o">:</span> <span class="s2">&quot;/another/file.js&quot;</span><span class="p">,</span> <span class="nx">__dirname</span><span class="o">:</span> <span class="s2">&quot;/another&quot;</span> <span class="p">};</span>

<span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="o">?</span> <span class="nx">anotherContext</span> <span class="o">:</span> <span class="p">{};</span>
<span class="kd">with</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">__filename</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></figure>

<p>In this example, we can&rsquo;t statically determine if <code>console.log(__filename)</code> is referring to the free <code>__filename</code>
variable, set to <code>&quot;/my/cool/file.js&quot;</code>, or if it&rsquo;s referring to the property of <code>anotherContext</code>, set to
<code>&quot;/another/file.js&quot;</code>.</p>

<p>Strict mode fixes this by <a href="http://es5.github.com/#x12.10.1">banning <code>with</code> entirely</a>. Thus, the above code would be a
syntax error if it were placed in a strict context.</p>

<h3 id="use-of-eval">Use of <code>eval</code></h3>

<p>Using <code>eval</code> in sloppy mode will introduce new variable bindings into your scope chain:</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="kd">function</span> <span class="nx">require</span><span class="p">(</span><span class="nx">moduleId</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// loading code elided.</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">requireStuff</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;function require(things) { console.log(&#39;We require more &#39; + things); }&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;minerals&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></figure>

<p>In this example, we have a similar problem as before: <code>eval</code> might have dynamically introduced a new variable binding.
Thus, <code>require</code> can refer either to the new function introduced by <code>eval</code> into <code>requireStuff</code>&rsquo;s scope, or to the
function declared in the outer scope. We just can&rsquo;t know, until runtime!</p>

<p>Strict mode fixes this by <a href="http://es5.github.com/#x10.4.2.1">disallowing <code>eval</code> from introducing new bindings</a>. Thus,
if the above code were strict, <code>require(&quot;minerals&quot;)</code> would always refer to the outer module-loading <code>require</code> function.</p>

<h2 id="why-does-this-matter?">Why Does This Matter?</h2>

<p>In addition to the obvious implications of this for optimization and inlining in JITers, this matters because static
analysis is becoming increasingly important in modern, complex JavaScript.</p>

<p>For example, let&rsquo;s say you were writing
<a href="https://github.com/substack/node-browserify">a tool for using Node.js-style modules in the browser</a>. To do so, you&rsquo;d
probably need to <a href="https://github.com/substack/module-deps">detect <code>require</code> calls</a>; in particular, if you see <code>require</code>,
you&rsquo;ll want to know what scope that <code>require</code> comes from: global or local? Similarly, you might want to
<a href="https://github.com/substack/insert-module-globals">detect</a> references to <code>__filename</code>, <code>__dirname</code>, <code>Buffer</code>, etc. and
make them available if they&rsquo;re detected.</p>

<p>But in sloppy mode, it is literally <em>unknowable</em> what a given variable refers to. At any time, an enclosing <code>with</code> or a
nearby <code>eval</code> could come along, and really ruin your day. In such a setting, static analysis is doomed; as we&rsquo;ve seen
in the above examples, the meaning of identifiers like <code>require</code> or <code>__filename</code> can&rsquo;t be determined until runtime.</p>

<h2 id="so?-just-don&#39;t-use-those-things">So? Just Don&rsquo;t Use Those Things</h2>

<p>A common refrain from people who <a href="https://twitter.com/izs/status/310833154401398784">can&rsquo;t handle typing `&ldquo;use strict&rdquo;</a>
is that they&rsquo;ll simply not use these features. And this indeed suffices: if you subset the language, perhaps using tools
like JSHint to enforce your subsetting rules, you can create a more sane programming environment.</p>

<p>Similar arguments are applied commonly in other languages, like prohibiting the use of exceptions or templates in C++.
Even telling people to not pass expressions to their <code>require</code> calls in Node.js modules falls under this category (with
the rationale that this breaks the popular browserify tool).</p>

<p>I don&rsquo;t buy these arguments. A language should give its users built-in tools to use it correctly. In the case of
JavaScript, there is one very clear tool that has been given: a simple, backward-compatible <code>&quot;use strict&quot;</code> pragma at the
top of your source files. If you think that&rsquo;s difficult, try being a C++ programmer and writing exception-safe code: the
techniques you need to use are a lot more involved than a single pragma.</p>

<h2 id="use-strict-mode">Use Strict Mode</h2>

<p>In <a href="http://www.youtube.com/watch?v=Kq4FpMe6cRs&amp;t=18m50s">the words of Mark Miller</a>, ECMAScript 5 strict mode has
transitioned JavaScript into the &ldquo;actually good&rdquo; category of programming languages. Let&rsquo;s use it. Opt in to static
scoping, and a saner language in general. Use strict.</p>

<p><em>This post was inspired by
<a href="http://www.mail-archive.com/es-discuss@mozilla.org/msg18408.html">a long-ago es-discuss thread</a>, which references
<a href="http://www.youtube.com/watch?v=Kq4FpMe6cRs&amp;t=42m53s">a talk by Mark Miller</a>. Further clarifications were had in
<a href="http://www.mail-archive.com/es-discuss@mozilla.org/msg22147.html">another, recent es-discuss thread</a>.</em></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/peer-dependencies/">Peer Dependencies</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-07T19:00:00-05:00" pubdate data-updated="true">Feb 7<sup>th</sup>, 2013</time>
        
         | <a href="/peer-dependencies/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>npm is awesome as a package manager. In particular, it handles sub-dependencies very well: if my package depends on
<code>request</code> version 2 and <code>some-other-library</code>, but <code>some-other-library</code> depends on <code>request</code> version 1, the resulting
dependency graph looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='text'>├── request@2.12.0
└─┬ some-other-library@1.2.3
  └── request@1.9.9
</code></pre></figure>

<p>This is, generally, great: now <code>some-other-library</code> has its own copy of <code>request</code> v1 that it can use, while not
interfering with my package&rsquo;s v2 copy. Everyone&rsquo;s code works!</p>

<h2 id="the-problem:-plugins">The Problem: Plugins</h2>

<p>There&rsquo;s one use case where this falls down, however: <em>plugins</em>. A plugin package is meant to be used with another &ldquo;host&rdquo;
package, even though it does not always directly <em>use</em> the host package. There are many examples of this pattern in the
Node.js package ecosystem already:</p>

<ul>
<li>Grunt <a href="http://gruntjs.com/#plugins-all">plugins</a></li>
<li>Chai <a href="http://chaijs.com/plugins">plugins</a></li>
<li>Levelup <a href="https://npmjs.org/package/level-hooks">plugins</a></li>
<li>Express <a href="http://expressjs.com/api.html#middleware">middleware</a></li>
<li>Winston <a href="https://github.com/flatiron/winston/blob/master/docs/transports.md">transports</a></li>
</ul>

<p>Even if you&rsquo;re not familiar with any of those use cases, surely you recall &ldquo;jQuery plugins&rdquo; from back when you were a
client-side developer: little <code>&lt;script&gt;</code>s you would drop into your page that would attach things to <code>jQuery.prototype</code>
for your later convenience.</p>

<p>In essence, plugins are designed to be used with host packages. But more importantly, they&rsquo;re designed to be used with
<em>particular versions</em> of host packages. For example, versions 1.x and 2.x of my <code>chai-as-promised</code> plugin work with
<code>chai</code> version 0.5, whereas versions 3.x work with <code>chai</code> 1.x. Or, in the faster-paced and less-semver–friendly world of
Grunt plugins, version 0.3.1 of <code>grunt-contrib-stylus</code> works with <code>grunt</code> 0.4.0rc4, but breaks when used with <code>grunt</code>
0.4.0rc5 due to removed APIs.</p>

<p>As a package manager, a large part of npm&rsquo;s job when installing your dependencies is managing their versions. But its
usual model, with a <code>&quot;dependencies&quot;</code> hash in <code>package.json</code>, clearly falls down for plugins. Most plugins never actually
depend on their host package, i.e. grunt plugins never do <code>require(&quot;grunt&quot;)</code>, so even if plugins did put down their host
package as a dependency, the downloaded copy would never be used. So we&rsquo;d be back to square one, with your application
possibly plugging in the plugin to a host package that it&rsquo;s incompatible with.</p>

<p>Even for plugins that do have such direct dependencies, probably due to the host package supplying utility APIs,
specifying the dependency in the plugin&rsquo;s <code>package.json</code> would result in a dependency tree with multiple copies of the
host package—not what you want. For example, let&rsquo;s pretend that <code>winston-mail</code> 0.2.3 specified <code>&quot;winston&quot;: &quot;0.5.x&quot;</code> in
its <code>&quot;dependencies&quot;</code> hash, since that&rsquo;s the latest version it was tested against. As an app developer, you want the
latest and greatest stuff, so you look up the latest versions of <code>winston</code> and of <code>winston-mail</code>, putting them in your
<code>package.json</code> as</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='json'><span class="p">{</span>
  <span class="nt">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;winston&quot;</span><span class="p">:</span> <span class="s2">&quot;0.6.2&quot;</span><span class="p">,</span>
    <span class="nt">&quot;winston-mail&quot;</span><span class="p">:</span> <span class="s2">&quot;0.2.3&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></figure>

<p>But now, running <code>npm install</code> results in the unexpected dependency graph of</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='text'>├── winston@0.6.2
└─┬ winston-mail@0.2.3
  └── winston@0.5.11
</code></pre></figure>

<p>I&rsquo;ll leave the subtle failures that come from the plugin using a different Winston API than the main application to
your imagination.</p>

<h2 id="the-solution:-peer-dependencies">The Solution: Peer Dependencies</h2>

<p>What we need is a way of expressing these &ldquo;dependencies&rdquo; between plugins and their host package. Some way of saying, &ldquo;I
only work when plugged in to version 1.2.x of my host package, so if you install me, be sure that it&rsquo;s alongside a
compatible host.&rdquo; We call this relationship a <em>peer dependency</em>.</p>

<p>The peer dependency idea has been kicked around for <a href="https://github.com/isaacs/npm/issues/930">literally</a>
<a href="https://github.com/isaacs/npm/issues/1400">years</a>. After
<a href="https://github.com/isaacs/npm/issues/1400#issuecomment-5932027">volunteering</a> to get this done &ldquo;over the weekend&rdquo; nine
months ago, I finally found a free weekend, and now peer dependencies are in npm!</p>

<p>Specifically, they were introduced in a rudimentary form in npm 1.2.0, and refined over the next few releases into
something I&rsquo;m actually happy with. Today Isaac packaged up npm 1.2.10 into
<a href="http://blog.nodejs.org/2013/02/06/node-v0-8-19-stable/">Node.js 0.8.19</a>, so if you&rsquo;ve installed the latest version of
Node, you should be ready to use peer dependencies!</p>

<p>As proof, I present you the results of trying to install <a href="https://npmjs.org/package/jitsu"><code>jitsu</code></a> 0.11.6 with npm
1.2.10:</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='text'>npm ERR! peerinvalid The package flatiron does not satisfy its siblings&#39; peerDependencies requirements!
npm ERR! peerinvalid Peer flatiron-cli-config@0.1.3 wants flatiron@~0.1.9
npm ERR! peerinvalid Peer flatiron-cli-users@0.1.4 wants flatiron@~0.3.0
</code></pre></figure>

<p>As you can see, <code>jitsu</code> depends on two Flatiron-related packages, which themselves peer-depend on conflicting versions
of Flatiron. Good thing npm was around to help us figure out this conflict, so it could be fixed in version 0.11.7!</p>

<h2 id="using-peer-dependencies">Using Peer Dependencies</h2>

<p>Peer dependencies are pretty simple to use. When writing a plugin, figure out what version of the host package you
peer-depend on, and add it to your <code>package.json</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='json'><span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;chai-as-promised&quot;</span><span class="p">,</span>
  <span class="nt">&quot;peerDependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;chai&quot;</span><span class="p">:</span> <span class="s2">&quot;1.x&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></figure>

<p>Now, when installing <code>chai-as-promised</code>, the <code>chai</code> package will come along with it. And if later you try to install
another Chai plugin that only works with 0.x versions of Chai, you&rsquo;ll get an error. Nice!</p>

<p>One piece of advice: peer dependency requirements, unlike those for regular dependencies, <em>should be lenient</em>. You
should not lock your peer dependencies down to specific patch versions. It would be really annoying if one Chai plugin
peer-depended on Chai 1.4.1, while another depended on Chai 1.5.0, simply because the authors were lazy and didn&rsquo;t spend
the time figuring out the actual minimum version of Chai they are compatible with.</p>

<p>The best way to determine what your peer dependency requirements should be is to actually follow
<a href="http://semver.org/">semver</a>. Assume that only changes in the host package&rsquo;s major version will break your plugin. Thus,
if you&rsquo;ve worked with every 1.x version of the host package, use <code>&quot;~1.0&quot;</code> or <code>&quot;1.x&quot;</code> to express this. If you depend on
features introduced in 1.5.2, use <code>&quot;&gt;= 1.5.2 &lt; 2&quot;</code>.</p>

<p>Now go forth, and peer depend!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/youre-missing-the-point-of-promises/">You&#8217;re Missing the Point of Promises</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-14T18:05:55-04:00" pubdate data-updated="true">Oct 14<sup>th</sup>, 2012</time>
        
         | <a href="/youre-missing-the-point-of-promises/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>This post originally appeared <a href="https://gist.github.com/domenic/3889970">as a gist</a>. Since then, the development of
Promises/A+ has made its emphasis on the Promises/A spec seem somewhat outdated.</em></p>

<p><em>Contrary to some mistaken statements on the internet, the problems with jQuery&rsquo;s promises explained here are not fixed
in recent versions; as of 2.1 beta 1 they have all the same problems outlined here, and according to one jQuery core
team member, <a href="http://esdiscuss.org/topic/a-challenge-problem-for-promise-designers-was-re-futures#content-43">they will forever remain broken</a>, in the name of backward compatibility.</em></p>

<p><strong>Promises</strong> are a software abstraction that makes working with asynchronous operations much more pleasant. In the most
basic definition, your code will move from continuation-passing style:</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="nx">getTweetsFor</span><span class="p">(</span><span class="s2">&quot;domenic&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// the rest of your code goes here.</span>
<span class="p">});</span>
</code></pre></figure>

<p>to one where your functions return a value, called a <em>promise</em>, which represents the eventual results of that operation.</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="kd">var</span> <span class="nx">promiseForTweets</span> <span class="o">=</span> <span class="nx">getTweetsFor</span><span class="p">(</span><span class="s2">&quot;domenic&quot;</span><span class="p">);</span>
</code></pre></figure>

<p>This is powerful since you can now treat these promises as first-class objects, passing them around, aggregating them,
and so on, instead of inserting dummy callbacks that tie together other callbacks in order to do the same.</p>

<p>I&rsquo;ve talked about how cool I think promises are <a href="http://www.slideshare.net/domenicdenicola/callbacks-promises-and-coroutines-oh-my-the-evolution-of-asynchronicity-in-javascript">at length</a>. This essay isn&rsquo;t about that. Instead, it&rsquo;s
about a disturbing trend I am seeing in recent JavaScript libraries that have added promise support: <em>they completely
miss the point of promises</em>.</p>

<h2 id="thenables-and-commonjs-promises/a">Thenables and CommonJS Promises/A</h2>

<p>When someone says &ldquo;promise&rdquo; in a JavaScript context, usually they mean—or at least <em>think</em> they
mean—<a href="http://wiki.commonjs.org/wiki/Promises/A">CommonJS Promises/A</a>. This is one of the smallest &ldquo;specs&rdquo; I&rsquo;ve seen. The meat of it is entirely about specifying
the behavior of a single function, <code>then</code>:</p>

<blockquote>
<p>A promise is defined as an object that has a function as the value for the property <code>then</code>:</p>

<p><code>then(fulfilledHandler, errorHandler, progressHandler)</code></p>

<p>Adds a <code>fulfilledHandler</code>, <code>errorHandler</code>, and <code>progressHandler</code> to be called for completion of a promise. The
<code>fulfilledHandler</code> is called when the promise is fulfilled. The <code>errorHandler</code> is called when a promise fails. The
<code>progressHandler</code> is called for progress events. All arguments are optional and non-function values are ignored. The
<code>progressHandler</code> is not only an optional argument, but progress events are purely optional. Promise implementors are
not required to ever call a <code>progressHandler</code> (the <code>progressHandler</code> may be ignored), this parameter exists so that
implementors may call it if they have progress events to report.</p>

<p>This function should return a new promise that is fulfilled when the given <code>fulfilledHandler</code> or <code>errorHandler</code>
callback is finished. This allows promise operations to be chained together. The value returned from the callback
handler is the fulfillment value for the returned promise. If the callback throws an error, the returned promise will
be moved to failed state.</p>
</blockquote>

<p>People mostly understand the first paragraph. It boils down to <em>callback aggregation</em>. You use <code>then</code> to attach
callbacks to a promise, whether for success or for errors (or even progress). When the promise transitions state—which
is out of scope of this very small spec!—your callbacks will be called. This is pretty useful, I guess.</p>

<p>What people don&rsquo;t seem to notice is the second paragraph. Which is a shame, since it&rsquo;s the most important one.</p>

<h2 id="what-is-the-point-of-promises?">What Is the Point of Promises?</h2>

<p>The thing is, promises are not <em>about</em> callback aggregation. That&rsquo;s a simple utility. Promises are about something
much deeper, namely providing a direct correspondence between synchronous functions and asynchronous functions.</p>

<p>What does this mean? Well, there are two very important aspects of synchronous functions:</p>

<ul>
<li>They <em>return values</em></li>
<li>They <em>throw exceptions</em></li>
</ul>

<p>Both of these are essentially about composition. That is, you can feed the return value of one function straight into
another, and keep doing this indefinitely. <em>More importantly</em>, if at any point that process fails, one function in the
composition chain can throw an exception, which then bypasses all further compositional layers until it comes into the
hands of someone who can handle it with a <code>catch</code>.</p>

<p>Now, in an asynchronous world, you can no longer return values: they simply aren&rsquo;t ready in time. Similarly, you can&rsquo;t
throw exceptions, because nobody&rsquo;s there to catch them. So we descend into the so-called &ldquo;callback hell,&rdquo; where
composition of return values involves nested callbacks, and composition of errors involves passing them up the chain
manually, and oh by the way you&rsquo;d better <em>never</em> throw an exception or else you&rsquo;ll need to introduce something crazy
like <a href="http://nodejs.org/api/domain.html">domains</a>.</p>

<p><em>The point of promises is to give us back functional composition and error bubbling in the async world.</em> They do this
by saying that your functions should return a promise, which can do one of two things:</p>

<ul>
<li>Become <em>fulfilled by a value</em></li>
<li>Become <em>rejected with an exception</em></li>
</ul>

<p>And, <em>if</em> you have a correctly implemented <code>then</code> function that follows Promises/A, then fulfillment and rejection will
compose just like their synchronous counterparts, with fulfillments flowing up a compositional chain, but being
interrupted at any time by a rejection that is only handled by someone who declares they are ready to handle it.</p>

<p>In other words, the following asynchronous code:</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="nx">getTweetsFor</span><span class="p">(</span><span class="s2">&quot;domenic&quot;</span><span class="p">)</span> <span class="c1">// promise-returning function</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">tweets</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">shortUrls</span> <span class="o">=</span> <span class="nx">parseTweetsForUrls</span><span class="p">(</span><span class="nx">tweets</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">mostRecentShortUrl</span> <span class="o">=</span> <span class="nx">shortUrls</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">return</span> <span class="nx">expandUrlUsingTwitterApi</span><span class="p">(</span><span class="nx">mostRecentShortUrl</span><span class="p">);</span> <span class="c1">// promise-returning function</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">httpGet</span><span class="p">)</span> <span class="c1">// promise-returning function</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span>
    <span class="kd">function</span> <span class="p">(</span><span class="nx">responseBody</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Most recent link text:&quot;</span><span class="p">,</span> <span class="nx">responseBody</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Error with the twitterverse:&quot;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">);</span>
</code></pre></figure>

<p>parallels<sup><a href="https://github.com/kriskowal/q/wiki/On-Exceptions">*</a></sup> the synchronous code:</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="k">try</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">tweets</span> <span class="o">=</span> <span class="nx">getTweetsFor</span><span class="p">(</span><span class="s2">&quot;domenic&quot;</span><span class="p">);</span> <span class="c1">// blocking</span>
  <span class="kd">var</span> <span class="nx">shortUrls</span> <span class="o">=</span> <span class="nx">parseTweetsForUrls</span><span class="p">(</span><span class="nx">tweets</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">mostRecentShortUrl</span> <span class="o">=</span> <span class="nx">shortUrls</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kd">var</span> <span class="nx">responseBody</span> <span class="o">=</span> <span class="nx">httpGet</span><span class="p">(</span><span class="nx">expandUrlUsingTwitterApi</span><span class="p">(</span><span class="nx">mostRecentShortUrl</span><span class="p">));</span> <span class="c1">// blocking x 2</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Most recent link text:&quot;</span><span class="p">,</span> <span class="nx">responseBody</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Error with the twitterverse: &quot;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></figure>

<p>Note in particular how errors flowed from any step in the process to our <code>catch</code> handler, without explicit by-hand
bubbling code. And with the upcoming ECMAScript 6 revision of JavaScript, plus some <a href="http://taskjs.org/">party tricks</a>, the code becomes
not only parallel but almost identical.</p>

<h2 id="that-second-paragraph">That Second Paragraph</h2>

<p>All of this is essentially enabled by that second paragraph:</p>

<blockquote>
<p>This function should return a new promise that is fulfilled when the given <code>fulfilledHandler</code> or <code>errorHandler</code>
callback is finished. This allows promise operations to be chained together. The value returned from the callback
handler is the fulfillment value for the returned promise. If the callback throws an error, the returned promise will
be moved to failed state.</p>
</blockquote>

<p>In other words, <code>then</code> is <em>not</em> a mechanism for attaching callbacks to an aggregate collection. It&rsquo;s a mechanism for
<em>applying a transformation</em> to a promise, and yielding a <em>new</em> promise from that transformation.</p>

<p>This explains the crucial first phrase: &ldquo;this function should return a new promise.&rdquo; Libraries like jQuery (before 1.8)
don&rsquo;t do this: they simply mutate the state of the existing promise. That means if you give a promise out to multiple
consumers, they can interfere with its state. To realize how ridiculous that is, consider the synchronous parallel: if
you gave out a function&rsquo;s return value to two people, and one of them could somehow change it into a thrown exception!
Indeed, Promises/A points this out explicitly:</p>

<blockquote>
<p>Once a promise is fulfilled or failed, the promise&rsquo;s value MUST not be changed, just as a values in JavaScript,
primitives and object identities, can not change (although objects themselves may always be mutable even if their
identity isn&rsquo;t).</p>
</blockquote>

<p>Now consider the last two sentences. They inform how this new promise is created. In short:</p>

<ul>
<li>If either handler returns a value, the new promise is fulfilled with that value.</li>
<li>If either handler throws an exception, the new promise is rejected with that exception.</li>
</ul>

<p>This breaks down into four scenarios, depending on the state of the promise. Here we give their synchronous parallels so
you can see why it&rsquo;s crucially important to have semantics for all four:</p>

<ol>
<li>Fulfilled, fulfillment handler returns a value: simple functional transformation</li>
<li>Fulfilled, fulfillment handler throws an exception: getting data, and throwing an exception in response to it</li>
<li>Rejected, rejection handler returns a value: a <code>catch</code> clause got the error and handled it</li>
<li>Rejected, rejection handler throws an exception: a <code>catch</code> clause got the error and re-threw it (or a new one)</li>
</ol>

<p>Without these transformations being applied, you lose all the power of the synchronous/asynchronous parallel, and your
so-called &ldquo;promises&rdquo; become simple callback aggregators. This is the problem with jQuery&rsquo;s current &ldquo;promises&rdquo;: they only
support scenario 1 above, omitting entirely support for scenarios 2–4. This was also the problem with Node.js 0.1&rsquo;s
<code>EventEmitter</code>-based &ldquo;promises&rdquo; (which weren&rsquo;t even <code>then</code>able).</p>

<p>Furthermore, note that by catching exceptions and transforming them into rejections, we take care of both intentional
and unintentional exceptions, just like in sync code. That is, if you write <code>aFunctionThatDoesNotExist()</code> in either
handler, your promise becomes rejected and that error will bubble up the chain to the nearest rejection handler just as
if you had written <code>throw new Error(&quot;bad data&quot;)</code>. Look ma, no domains!</p>

<h2 id="so-what?">So What?</h2>

<p>Maybe you&rsquo;re breathlessly taken by my inexorable logic and explanatory powers. More likely, you&rsquo;re asking yourself why
this guy is raging so hard over some poorly-behaved libraries.</p>

<p>Here&rsquo;s the problem:</p>

<blockquote>
<p>A promise is defined as an object that has a function as the value for the property <code>then</code></p>
</blockquote>

<p>As authors of Promises/A-consuming libraries, we would like to assume this statement to be true: that something that
is &ldquo;thenable&rdquo; actually behaves as a Promises/A promise, with all the power that entails.</p>

<p>If you can make this assumption, you can write <a href="https://github.com/domenic/chai-as-promised/">very extensive libraries</a> that are entirely agnostic
to the implementation of the promises they accept! Whether they be from <a href="https://github.com/kriskowal/q">Q</a>, <a href="https://github.com/cujojs/when">when.js</a>, or even <a href="http://msdn.microsoft.com/en-us/library/windows/apps/br211867.aspx">WinJS</a>, you can
use the simple composition rules of the Promises/A spec to build on promise behavior. For example, here&rsquo;s a generalized
<a href="https://gist.github.com/2936696">retry function</a> that works with any Promises/A implementation.</p>

<p>Unfortunately, libraries like jQuery break this. This necessitates <a href="https://github.com/domenic/chai-as-promised/blob/4bc1d6b217acde85c8af56dc3cd09f05bb752549/lib/chai-as-promised.js#L28-30">ugly hacks</a> to detect the presence of objects
masquerading as promises, and who call themselves in their API documentation promises, but aren&rsquo;t really Promises/A
promises. If the consumers of your API start trying to pass you jQuery promises, you have two choices: fail in
mysterious and hard-to-decipher ways when your compositional techniques fail, or fail up-front and block them from using
your library entirely. This sucks.</p>

<h2 id="the-way-forward">The Way Forward</h2>

<p>So this is why I want to avoid an unfortunate <a href="https://github.com/emberjs/ember.js/commit/f7ac080db3a2a15f5814dc26fc86712cf7d252c8">callback aggregator solution</a> ending up in Ember. That&rsquo;s why I
wrote this essay. And that&rsquo;s why, in the hours following writing the original version of this essay, I worked up
<a href="https://github.com/domenic/promise-tests">a general Promises/A compliance suite</a> that we can all use to get on the same page in the future.</p>

<p>Since the release of that test suite, great progress has been made in promise interoperability and understanding. One
library, <a href="https://github.com/tildeio/rsvp.js">rsvp.js</a>, was released with the explicit goal of providing these features of Promises/A. Others
<a href="https://twitter.com/wookiehangover/status/258641272913412096">followed suit</a>. But the most exciting result was the formation of the <a href="https://github.com/promises-aplus">Promises/A+ organization</a>,
a loose coalition of implementors who have produced the <a href="http://promises-aplus.github.com/promises-spec/">Promises/A+ specification</a> extending and
clarifying the prose of the original Promises/A spec into something unambiguous and <a href="https://github.com/promises-aplus/promises-tests">well-tested</a>.</p>

<p>There&rsquo;s still work to be done, of course. Notably, at current time of writing, the latest jQuery version is 1.9.1, and
its promises implementation is completely broken with regard to the error handling semantics. Hopefully, with the above
explanation to set the stage and the Promises/A+ spec and test suite in place, this problem can be corrected in jQuery
2.0.</p>

<p>In the meantime, here are the libraries that conform to Promises/A+, and that I can thus unreservedly recommend:</p>

<ul>
<li><a href="https://github.com/kriskowal/q">Q</a> by Kris Kowal and myself: a full-featured promise library with a large, powerful API surface, adapters for
Node.js, progress support, and preliminary support for long stack traces.</li>
<li><a href="https://github.com/tildeio/rsvp.js">RSVP.js</a> by Yehuda Katz: a very small and lightweight, but still fully compliant, promise library.</li>
<li><a href="https://github.com/cujojs/when">when.js</a> by Brian Cavalier: an intermediate library with utilities for managing collections of eventual tasks,
as well as support for both progress and cancellation.</li>
</ul>

<p>If you are stuck with a crippled &ldquo;promise&rdquo; from a source like jQuery, I recommend using one of the above libraries&#39;
assimilation utilities (usually under the name <code>when</code>) to convert to a real promise as soon as possible. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><pre class='highlight'><code class='js'><span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;https://github.com/kriskowal/q&quot;</span><span class="p">));</span>
<span class="c1">// aaaah, much better</span>
</code></pre></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/portable-nodejs-code/">Portable Node.js Code</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-01T20:00:00-04:00" pubdate data-updated="true">Oct 1<sup>st</sup>, 2012</time>
        
         | <a href="/portable-nodejs-code/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>This post originally appeared <a href="https://gist.github.com/domenic/2790533">as a gist</a>, and then
<a href="http://nodeblog.azurewebsites.net/how-to-write-portable-nodejs-code">on the Node on Azure blog</a>.</em></p>

<p>Node.js core does its best to treat every platform equally. Even if most Node developers use OS X day to day, some use
Windows, and most everyone deploys to Linux or Solaris. So it&rsquo;s important to keep your code portable between platforms,
whether you&rsquo;re writing a library or an application.</p>

<p>Predictably, most cross-platform issues come from Windows. Things just work differently there! But if you&rsquo;re careful,
and follow some simple best practices, your code can run just as well on Windows systems.</p>

<h2 id="paths-and-urls">Paths and URLs</h2>

<p>On Windows, paths are constructed with backslashes instead of forward slashes. So if you do your directory manipulation
by splitting on <code>&quot;/&quot;</code> and playing with the resulting array, <a href="https://github.com/logicalparadox/codex/commit/7f91b451e7cdc9d794f30bd026029aea797bb1e0">your code will fail dramatically on Windows</a>.</p>

<p>Instead, you should be using the <a href="http://nodejs.org/docs/latest/api/path.html">path module</a>. So instead of resolving paths with string contatenation, e.g.
<code>x + &quot;/&quot; + y</code>, you should instead do <code>path.resolve(x, y)</code>. Similarly, instead of relativizing paths with string
replacement, e.g. <code>x.replace(/^parent\/dirs\//, &quot;&quot;)</code>, you <a href="https://github.com/ryanmcgrath/wrench-js/commit/01190602dac64924fca2dae11912ffb560e636a0">should</a> do <code>path.relative(&quot;/parent/dirs&quot;, y)</code>.</p>

<p>Another area of concern is that, when writing portable code, you cannot count on URLs and module IDs having the same
separators as paths. If you use something like <code>path.join</code> <a href="https://github.com/domenic/knox/compare/eabef00df9bf79085229f4ed39b2679eb579ea20...9b1a4e9f644ababd5d9ced227de44709e1fccf4b">on a URL</a>, Windows users will get URLs containing
backslashes! <a href="https://github.com/isaacs/npm-www/pull/88">Similarly</a> for <code>path.normalize</code>, or in general any path methods. All this applies if you&rsquo;re
<a href="https://github.com/substack/node-browserify/pull/158">working with module IDs</a>, too: they are forward-slash delimited, so you shouldn&rsquo;t use path functions with
them either.</p>

<h2 id="non-portable-apis">Non-portable APIs</h2>

<p>Windows is completely missing the <code>process.(get|set)(gid|uid)</code> methods, so calling them will instantly crash your
program on Windows. Always <a href="https://github.com/flatiron/winston/commit/a32d92ba1be3c21859d8c1c9e8e0e701846fcaf4">guard such calls</a> with a conditional.</p>

<p>The <a href="http://nodejs.org/docs/latest/api/fs.html#fs_fs_watchfile_filename_options_listener"><code>fs.watchFile</code></a> API is not sufficiently cross-platform, and is recommended against in the docs because
of it. You <a href="https://github.com/logicalparadox/codex/commit/be2fe18f5561f7bbd3bd0099bb47f7e58c23638d">should</a> use <a href="http://nodejs.org/docs/latest/api/fs.html#fs_fs_watch_filename_options_listener"><code>fs.watch</code></a> instead.</p>

<p>The <a href="http://nodejs.org/api/child_process.html">child_process module</a> requires care cross-platform. In particular, <code>spawn</code> and <code>execFile</code> do not execute in a
shell, which means that on Windows only <code>.exe</code> files will run. This is rather problematic, as many cross-platform
binaries are included on Windows as <code>.cmd</code> or <code>.bat</code> files, <a href="https://github.com/isaacs/npm/issues/2333">among them Git</a>, <a href="https://github.com/isaacs/npm-www/blob/fd3a96e861989338676937736599598f7c0fde8f/dev/go.js#L22-27">CouchDB</a>, and
many others. So if you&rsquo;re using these APIs, things will likely work great on OS X, Linux, etc. But when you tell your
users “just install the Git build for Windows, and make sure it&rsquo;s in your path!” that ends up not being sufficient.
There is <a href="https://github.com/joyent/node/issues/2318">talk</a> of fixing this behavior in libuv, but that&rsquo;s still tentative. In the meantime, if you don&rsquo;t
need to stream your output, <code>exec</code> works well. Otherwise you&rsquo;ll need <a href="https://github.com/isaacs/npm-www/blob/fd3a96e861989338676937736599598f7c0fde8f/dev/go.js#L22-27">branching logic</a> to take care
of Windows.</p>

<p>A final edge-case comes when using named sockets, e.g. with <code>net.connect</code>. On Unix, simple filenames suffice, but on
Windows, they must conform to a <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa365783%28v=vs.85%29.aspx">bizarre syntax</a>. There&rsquo;s not really a better solution for this than
<a href="https://gist.github.com/2790533#gistcomment-331356">branching per-platform</a>.</p>

<h2 id="being-windows-developer-friendly">Being Windows-Developer Friendly</h2>

<p>One of the most egregious problems with many projects is their unnecessary use of Unix Makefiles. Windows does not have
a <code>make</code> command, so the tasks stored in these files are entirely inaccessible to Windows users who might try to
contribute to your project. This is especially annoying if you put your test command in there!</p>

<p>Fortunately, we have a solution: npm comes with a <a href="https://npmjs.org/doc/scripts.html">scripts feature</a> where you can include commands to be
run for testing (<code>test</code>), installation (<code>install</code>), building (<code>prepublish</code>), and starting your app (<code>start</code>), among many
others. You can also create custom scripts, which are then run with <code>npm run &lt;script-name&gt;</code>; I often use this for
<a href="https://github.com/domenic/sinon-chai/blob/baf878ee7ba98bae507ac8bc91c94ea1fe287964/package.json#L28">lint steps</a>. Also of note, you can reference any commands your app depends on by their short names here: for
example, <code>&quot;mocha&quot;</code> instead of <code>&quot;./node_modules/.bin/mocha&quot;</code>. So, please use these! If you must have a Makefile for
whatever reason, just have it <a href="https://github.com/LearnBoost/knox/blob/c1b680c80b7a4493970e3e9a92305387ef96c1eb/Makefile#L2-3">delegate to an npm script</a>.</p>

<p>Another crucially important step is not using Unix shell scripts as part of your development process. Windows doesn&rsquo;t
have bash, or <code>ls</code>, or <code>mv</code>, or any of those other commands you might use. Instead, write your shell scripts
<a href="http://www.2ality.com/2011/12/nodejs-shell-scripting.html">in JavaScript</a>, using a tool like <a href="http://gruntjs.com/">Grunt</a> if you&rsquo;d like.</p>

<h2 id="bonus:-something-that-breaks-on-linux-and-solaris!">Bonus: Something that Breaks on Linux and Solaris!</h2>

<p>Both Windows and, by default, OS X, use case-insensitive file systems. That means if you install a package named foo,
any of <code>require(&quot;foo&quot;)</code> or <code>require(&quot;FOO&quot;)</code> or <code>require(&quot;fOo&quot;)</code> will work—on Windows and OS X. But then when you go to
deploy your code, out of your development environment and into your Linux or Solaris production system, the latter two
will <em>not</em> work! So it&rsquo;s a little thing, but make sure you always get your module and package name casing right.</p>

<h2 id="conclusion">Conclusion</h2>

<p>As you can see, writing cross-platform code is sometimes painful. Usually, it&rsquo;s just a matter of best practices, like
using the path module or remembering that URLs are different from filesystem paths. But sometimes there are APIs that
just don&rsquo;t work cross-platform, or have annoying quirks that necessitate branching code.</p>

<p>Nevertheless, it&rsquo;s worth it. Node.js is the most exciting software development platform in recent memory, and one of its
greatest strengths is its portable nature. Try your best to uphold that!</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/the-revealing-constructor-pattern/">The Revealing Constructor Pattern</a>
      </li>
    
      <li class="post">
        <a href="/continual-progress-in-the-w3c-tag/">Continual Progress in the W3C TAG</a>
      </li>
    
      <li class="post">
        <a href="/the-extensible-web/">The Extensible Web</a>
      </li>
    
      <li class="post">
        <a href="/es6-iterators-generators-and-iterables/">ES6 Iterators, Generators, and Iterables</a>
      </li>
    
      <li class="post">
        <a href="/explaining-away-the-webs-magic/">Explaining Away the Web&#8217;s Magic</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/domenic">@domenic</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'domenic',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Domenic Denicola -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'hiddenvariables';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
